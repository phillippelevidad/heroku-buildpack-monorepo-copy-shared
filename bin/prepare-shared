#!/bin/bash

# This script copies the shared folder into frontend/apps/app
# It should be run BEFORE the monorepo buildpack
# 
# To use this as a buildpack:
# 1. Copy the contents of custom-buildpack/ to your buildpack repository
# 2. Add it as the first buildpack before the monorepo one

set -e

echo "-----> Preparing shared folder for monorepo buildpack"

# BUILD_DIR is set by the compile script (from Heroku's $1 argument)
# This is where Heroku cloned the git repository
# If not set, try to detect it

if [ -z "$BUILD_DIR" ]; then
  CURRENT_DIR="$(pwd)"
  
  # Try to find the repository root by looking for 'shared' and 'frontend' directories
  # Start from current directory and go up
  FOUND_ROOT=""
  SEARCH_DIR="$CURRENT_DIR"
  MAX_DEPTH=10
  DEPTH=0
  
  while [ $DEPTH -lt $MAX_DEPTH ] && [ "$SEARCH_DIR" != "/" ]; do
    if [ -d "$SEARCH_DIR/shared" ] && [ -d "$SEARCH_DIR/frontend" ]; then
      FOUND_ROOT="$SEARCH_DIR"
      break
    fi
    SEARCH_DIR="$(dirname "$SEARCH_DIR")"
    DEPTH=$((DEPTH + 1))
  done
  
  BUILD_DIR="${FOUND_ROOT:-$CURRENT_DIR}"
fi

# Use absolute paths
APP_DIR="$BUILD_DIR/frontend/apps/app"
SHARED_SOURCE="$BUILD_DIR/shared"
SHARED_DEST="$APP_DIR/shared"

echo "       Build directory: $BUILD_DIR"
echo "       Checking for shared folder at: $SHARED_SOURCE"
echo "       Checking for app directory at: $APP_DIR"

# Check if shared folder exists at repo root and app directory exists
if [ -d "$SHARED_SOURCE" ] && [ -d "$APP_DIR" ]; then
  echo "       Copying shared folder into $APP_DIR..."
  rm -rf "$SHARED_DEST" 2>/dev/null || true
  cp -r "$SHARED_SOURCE" "$SHARED_DEST"
  echo "       âœ“ Shared folder copied successfully"
  echo "       The monorepo buildpack will now copy $APP_DIR (with shared) to root"
  exit 0
else
  echo "       WARNING: Shared folder or app directory not found"
  echo "       Shared source: $SHARED_SOURCE (exists: $([ -d "$SHARED_SOURCE" ] && echo 'yes' || echo 'no'))"
  echo "       App directory: $APP_DIR (exists: $([ -d "$APP_DIR" ] && echo 'yes' || echo 'no'))"
  echo "       Current working directory: $(pwd)"
  echo "       Listing build directory contents:"
  ls -la "$BUILD_DIR" 2>/dev/null | head -20 || echo "       Cannot list build directory"
  # Don't fail - let the monorepo buildpack continue
  exit 0
fi

